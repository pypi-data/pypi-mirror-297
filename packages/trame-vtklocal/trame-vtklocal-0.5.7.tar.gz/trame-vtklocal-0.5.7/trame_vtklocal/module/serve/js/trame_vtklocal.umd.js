(function(y,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],i):(y=typeof globalThis<"u"?globalThis:y||self,i(y.trame_vtklocal={},y.Vue))})(this,function(y,i){"use strict";async function N(o,a){const l={canvas:o,locateFile(){return a},print(){console.info(Array.prototype.slice.call(arguments).join(" "))},printErr(){console.error(Array.prototype.slice.call(arguments).join(" "))}},c=await window.createVTKWasmSceneManager(l);return c.initialize(),c}function W(o,a){const l=Number(a);return o.updateStateFromObject(l),o.getState(l)}function R(o){const a={};return function(c){return a[c]||(a[c]=W(o,c)),a[c]}}function U(o,a){const l=Array.isArray(a)?a:[a];let c=null;for(let u=0;u<l.length;u++){const g=l[u];u===0?c=o(g):(c=c[g],c.Id&&(c=o(c.Id)))}return c}function C(o,a,l){return function(){const c=R(a);for(const[u,g]of Object.entries(l)){const m={};for(const[w,p]of Object.entries(g))m[w]=U(c,p);o.state.set(u,m)}}}const x={VtkLocal:{emits:["updated","memory-vtk","memory-arrays","camera"],props:{renderWindow:{type:Number},eagerSync:{type:Boolean,default:!1},cacheSize:{type:Number,default:1e8},wsClient:{type:Object},listeners:{type:Object}},setup(o,{emit:a}){const l=i.inject("trame"),c=l.state.get("__trame_vtklocal_wasm_url"),u=[],g=[],m=[],w=i.ref(null),p=i.ref(null),S=o.wsClient||(l==null?void 0:l.client),j={},h={},k={},v=i.ref(1),z=i.toRef(o,"listeners");let t=null,M=0,O=null;function P([e]){if(e.type==="state"){const{mtime:r,content:s,id:n}=e;t.registerState(s),j[n]=r}if(e.type==="blob"){const{hash:r,content:s}=e;k[r]=new Promise(n=>{s.arrayBuffer?s.arrayBuffer().then(f=>{t.registerBlob(r,new Uint8Array(f)),n()}):(t.registerBlob(r,s),n())})}}async function L(){const e=S.getConnection().getSession();O=e.subscribe("vtklocal.subscriptions",P),await e.call("vtklocal.subscribe.update",[o.renderWindow,1])}async function D(){const e=S.getConnection().getSession();O&&(e.unsubscribe(O),O=null),await e.call("vtklocal.subscribe.update",[o.renderWindow,-1])}function A(){const{width:e,height:r}=w.value.getBoundingClientRect(),s=Math.floor(e*window.devicePixelRatio+.5),n=Math.floor(r*window.devicePixelRatio+.5),f=i.unref(p);f&&t&&o.renderWindow&&(f.width=s,f.height=n,t.setSize(o.renderWindow,s,n),t.render(o.renderWindow))}let T=new ResizeObserver(A);async function _(e){const s=await S.getConnection().getSession().call("vtklocal.get.state",[e]);return s.length>0?(j[e]=JSON.parse(s).MTime,t.registerState(s)):console.log(`Server returned empty state for ${e}`),s}async function F(e){if(k[e]){await k[e],h[e]=i.unref(v),delete k[e];return}const s=await S.getConnection().getSession().call("vtklocal.get.hash",[e]),n=s.arrayBuffer?new Uint8Array(await s.arrayBuffer()):s;return t.registerBlob(e,n),h[e]=i.unref(v),n}function I(){const e=t.getTotalVTKDataObjectMemoryUsage(),r=t.getTotalBlobMemoryUsage(),s=Number(o.cacheSize)+e;if(r>s){const n={};let f=i.unref(v);for(Object.entries(h).forEach(([d,b])=>{b<f&&(f=b);const E=b.toString();n[E]?n[E].push(d):n[E]=[d]});t.getTotalBlobMemoryUsage()>s;){const d=n[f];if(d)for(let b=0;b<d.length;b++)t.unRegisterBlob(d[b]),delete h[d[b]];f++}}a("memory-vtk",t.getTotalVTKDataObjectMemoryUsage()),a("memory-arrays",t.getTotalBlobMemoryUsage())}async function B(){if(M++,M===1)try{const r=await S.getConnection().getSession().call("vtklocal.get.status",[o.renderWindow]),s=[];r.ids.forEach(([n,f])=>{(!j[n]||j[n]<f)&&s.push(_(n))}),u.push(...r.cameras),r.ignore_ids.forEach(n=>{t.unRegisterState(n)}),r.hashes.forEach(n=>{h[n]||s.push(F(n)),h[n]=i.unref(v)}),await Promise.all(s),v.value++;try{t.updateObjectsFromStates(),t.render(o.renderWindow),A()}catch(n){console.error("WASM update failed"),console.log(n)}a("updated"),I()}catch(e){console.error("Error in update",e)}finally{M--,M&&(M=0,await B())}}function K(e){t.resetCamera(e),t.render(o.renderWindow)}i.onMounted(async()=>{t=await N(i.unref(p),c),o.eagerSync&&L(),await B();for(let e=0;e<u.length;e++){const r=Number(u[e]);g.push([r,t.addObserver(r,"ModifiedEvent",()=>{a("camera",W(t,r))})])}i.watchEffect(()=>{for(;m.length;){const[e,r]=m.pop();t.removeObserver(e,r)}for(const[e,r]of Object.entries(z.value||{})){const s=Number(e);for(const[n,f]of Object.entries(r||{})){const d=C(l,t,f);m.push([s,t.addObserver(s,n,d)]),d()}}}),t.startEventLoop(o.renderWindow),T&&T.observe(i.unref(w))}),i.onBeforeUnmount(()=>{for(O&&D();g.length;){const[e,r]=g.pop();t.removeObserver(e,r)}for(;m.length;){const[e,r]=m.pop();t.removeObserver(e,r)}t.stopEventLoop(o.renderWindow),T&&(T.disconnect(),T=null)});function q(e){C(l,t,e)()}return{container:w,canvas:p,update:B,resetCamera:K,evalStateExtract:q}},template:`
        <div ref="container" style="position: relative; width: 100%; height: 100%;">
          <canvas 
            id="canvas"
            ref="canvas" 
            style="position: absolute; left: 0; top: 0; width: 100%; height: 100%;" 
            tabindex="0"
            
            @contextmenu.prevent
            @click="canvas.focus()"
            @mouseenter="canvas.focus()"
          />
        </div>`}};function V(o){Object.keys(x).forEach(a=>{o.component(a,x[a])})}y.install=V,Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});
