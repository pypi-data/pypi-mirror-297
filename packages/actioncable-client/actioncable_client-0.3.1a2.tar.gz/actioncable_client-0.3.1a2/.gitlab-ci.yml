---
# We basically use Auto-DevOps with some customizations.
include:
# - template: Jobs/Code-Quality.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml

# reset stages to reflect what we will be doing
stages:
  - build
  - test
  - deploy

# A lot of env variables are defined in interface gitlab.org :
#  https://gitlab.com/groups/liant-sasu/-/settings/ci_cd

# This project variables
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# https://pip.pypa.io/en/stable/topics/caching/
cache:
  paths:
    - .cache/pip

image: python:latest

build:
  stage: build
  before_script:
    - pip install --upgrade build
  script:
    - python -m build
  artifacts:
    untracked: false
    when: on_success
    access: all
    expire_in: "2 hours"
    paths:
      - dist/

code_quality:
  stage: test
  image: python:3.12-slim
  script:
    - pip install ruff
    - pip install -r requirements.txt
    - ruff check --exit-zero --output-format gitlab --output-file codequality-ruff.json
  artifacts:
    reports:
      codequality: codequality-ruff.json
    expire_in: 1 week
    when: always

type_check:
  stage: test
  allow_failure: true
  image: rlaures/pyright2gitlab-ci:node-current-alpine-latest
  before_script:
    - >
      python3 -m venv .venv
      && source .venv/bin/activate
    - pip install pytest-mock callee mypy types-requests
    - pip install -r requirements.txt
  script:
   - pyright --outputjson src tests > report_raw.json
  after_script:
   - pyright-to-gitlab-ci --src report_raw.json --output codequality-pyright.json --base_path .
  artifacts:
    reports:
      codequality: codequality-pyright.json
    expire_in: 1 week
    when: always


pages:
  stage: deploy
  image: alpine:latest
  script:
    - echo
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

test:
  stage: test
  image: rlaures/pyenv:python-3.12-alpine3.20-latest
  coverage: /(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/
  before_script:
    - pyenv local 3.12 3.11 3.10 3.9
    - pyenv shims
    - pip install tox
  script:
    - tox
  artifacts:
    when: always
    paths:
      - coverage.xml
      - .coverage
      - report.xml
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

gitlab-deploy:
  stage: deploy
  script:
    - |
      if [ ! -d 'dist' ] || [ "$(ls -A dist)" = "" ]; then
        echo No package found in dist/, check in your pipeline the package-build job to know why.
        echo Failing package push.
        exit 1
      fi
    - python3 -m pip install twine
    - >
      TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token
      python -m twine upload
      --repository-url https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi
      dist/*
  needs:
    - build
    - test
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      # You can accept failure here if you want
      # allow_failure: true
      when: on_success

pypi-deploy:
  stage: deploy
  script:
    - python3 -m pip install twine
    - |
      if [ "$PYPI_TOKEN" = "" ]; then
        echo Please define PYPI_TOKEN in the project Gitlab CI/CD > variable settings: https://gitlab.com/${CI_PROJECT_PATH}/-/settings/ci_cd
        echo And then retry this job.
        echo You define this token on the "API token" section of your pypi account https://pypi.org/manage/account/
        exit 1
      fi
    - TWINE_PASSWORD=${PYPI_TOKEN} TWINE_USERNAME=__token__ python -m twine upload dist/*
  needs:
    - build
    - test
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
