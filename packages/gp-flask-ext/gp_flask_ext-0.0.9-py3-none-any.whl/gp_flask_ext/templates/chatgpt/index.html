{% extends 'base.html' %}

{% block title %}ChatGPT{% endblock %}

{% block style %}
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.10.0/styles/default.min.css">
<style>
  #app {
    width: 1024px;
    margin: auto;
  }

  .el-main {
    background-color: #E9EEF3;
    color: #333;
  }
</style>
{% endblock %}

{% block content %}
<div id="app" v-loading="loading">
  <el-container>
    <el-main>
      <el-row>
        <h1>ChatGPT</h1>
      </el-row>
      <el-row>
        <el-form ref="form" :model="form" label-width="80px">
          <el-form-item label="提问">
            <el-input v-model="form.user_input" placeholder="输入问题"></el-input>
          </el-form-item>
          <div v-show="show">
            <el-form-item label="模型">
              <el-select v-model="form.model" placeholder="模型">
                <el-option v-for="item in models" :key="item.value" :label="item.label" :value="item.value"></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="最大字数">
              <el-slider v-model="form.max_tokens" :min="1" :max="2048" :step="32"></el-slider>
            </el-form-item>
            <el-form-item label="温度">
              <el-slider v-model="form.temperature" :min="0" :max="1" :step="0.1"></el-slider>
            </el-form-item>
            <el-form-item label="Top P">
              <el-slider v-model="form.top_p" :min="0" :max="1" :step="0.1"></el-slider>
            </el-form-item>
            <el-form-item label="频率惩罚">
              <el-slider v-model="form.frequency_penalty" :min="0" :max="2" :step="0.1"></el-slider>
            </el-form-item>
            <el-form-item label="存在惩罚">
              <el-slider v-model="form.presence_penalty" :min="0" :max="2" :step="0.1"></el-slider>
            </el-form-item>
          </div>
          <el-form-item>
            <el-button type="primary" @click="ask">提问</el-button>
            <el-button @click="show = !show">高级选项</el-button>
          </el-form-item>
        </el-form>
      </el-row>
      <el-row>
        <div id="md"></div>
      </el-row>
    </el-main>
  </el-container>
</div>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.10.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // 从Flask模板引擎传递变量
  const app = new Vue({
    el: '#app',
    // 分隔符以为 [[]], 避免与Flask模板语言冲突
    delimiters: ['[[', ']]'],
    data: () => ({
      form: {
        user_input: "",
        model: "4o-test",
        max_tokens: 500,
        temperature: 0.5,
        top_p: 1.0,
        frequency_penalty: 1.0,
        presence_penalty: 1.0,
      },
      show: false,    // 是否显示高级选项
      models: [
        { value: "4o-test", label: "4o-test" },
        { value: "gpt-3.5-turbo", label: "gpt-3.5-turbo" },
      ],
      answer: "",
      loading: false,
    }),
    methods: {
      ask() {
        this.loading = true
        axios.post("{{ url_for('chatgpt.ask') }}", this.form)
          .then(response => {
            this.answer = response.data
            const el = document.getElementById("md");
            el.innerHTML = marked.parse(this.answer)
            hljs.highlightAll();
            this.loading = false
          })
          .catch(error => {
            console.log(error)
            this.loading = false
          })
      }
    },
    mounted() {
      // this.init()
    }
  })
</script>
{% endblock %}