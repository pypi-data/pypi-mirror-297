# Adapted from https://docs.gitlab.com/ee/ci/caching/#cache-python-dependencies.
# We use alpine based image instead of micromamba (tiny image and faster setup).
default:
  image: python:alpine
  cache:
    paths:
      - .cache/pip
  before_script:
    - apk add --no-cache g++ clang git libc-dev openmp-dev suitesparse-dev


variables:
  # Change pip's cache directory to be inside the project directory since we can
  # only cache local items.
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Needed for pip to find suitesparse headers when building scikit-sparse
  SUITESPARSE_INCLUDE_DIR: /usr/include/suitesparse/suitesparse


test-gcc:
  stage: test
  script:
    # We need numpy<2 because of extinction package compiled on numpy-1.*
    - pip install "numpy<2" git+https://github.com/nregnault/sncosmo
    - VERBOSE=1 CXX=g++ pip install -v .[test]
    - pytest -v


test-clang:
  stage: test
  script:
    # We need numpy<2 because of extinction package compiled on numpy-1.*
    - pip install "numpy<2" git+https://github.com/nregnault/sncosmo
    - VERBOSE=1 CXX=clang++ pip install -v .[test]
    - pytest -v


sdist:
  stage: deploy
  script:
    - pip install build
    - python -m build --sdist --outdir dist
  artifacts:
    paths:
      - dist/*.tar.gz


pypi:
  # publish the source distribution on https://pypi.org/project/bbf/, only when
  # a new tag
  stage: deploy
  needs: ["sdist"]
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - pip install twine
    - twine upload --non-interactive --repository pypi dist/*
